clc
clear all
close all
%Input data
addpath('./functions/');
addpath('./functions/spo2ida_allT');
Gamma = [1	1	1	1	1];
T = [1.0037	0.77964	0.74098	0.63234	0.48996];
Tav = 0.696;
Sa_ratios = [ 1.6391934   1.22582094  1.11783742  0.92913515  0.72870817];
SPO = [0.099	0.206	0.300	0.300	91.431	91.431	84.659;...
    0.061	0.147	0.300	0.300	63.103	63.103	54.743;...
    0.067	0.130	0.300	0.300	54.735	54.735	45.919;...
    0.065	0.184	0.300	0.300	141.680	141.680	120.290;...
    0.082	0.206	0.3	0.3	111.26	111.26	108.06];
dcroof = [0.076  0.151  0.226  0.3  0.3;... 
    0.08  0.159  0.239  0.3  0.3;...
    0.073  0.145  0.218  0.29  0.3;...
    0.061  0.122  0.183  0.243  0.3;...
    0.066  0.132  0.198  0.263  0.3];
mc = [2.084909223	2.423581556	1.956319743	2.830657081	2.520028965];
a = [0	0	0	0	0];
ac = [0.078258456	0.052634904	0.063318462	0.084335985	0.024990005];
r = [0.925933217	0.867518185	0.838933041	0.849025974	0.94];
mf = [3.031347296	4.940577053	4.500079544	4.620806632	3.670947477];

noBlg = 5;
w = [0.1 0.2	0.3	0.3	0.1];
bUthd = [0.	0.	0.1	0.2	0.3];
g = 9.81;
MC = 10;
iml = 0.1:0.1:1;

xp=linspace( 1./(2*MC),1-1./(2*MC), MC);

for blg = 1:noBlg
    dry(blg) = SPO(blg,1);
    [spoc,idac(blg,:),cap]=spo2ida_allT(mc(blg),a(blg),ac(blg),r(blg),mf(blg),T(blg));
end

for blg = 1:noBlg
    for i = 1:length(dcroof)
        if bUthd(i) >0
            drlim_sample=logninv(xp,log(dcroof(blg,i)),bUthd(i));
            for j = 1:length(drlim_sample)            
                [SaR50,bRSa,SaT50,bTSa]=SPO2IDAfragility(idac(blg,:), dry(blg),drlim_sample(j),0,mf(blg),T(blg),Gamma(blg),g,MC);
                Sa50(j) = SaT50;
                bSa(j) = bTSa;
            end
        else
            [SaR50,bRSa,SaT50,bTSa]=SPO2IDAfragility(idac(blg,:), dry(blg),dcroof(blg,i),0,mf(blg),T(blg),Gamma(blg),g,MC);
            Sa50 = ones(1,MC)*SaT50;
            bSa = ones(1,MC)*bTSa;
        end
        Sa50
        Sa{i} = log(Sa50)*Sa_ratios(blg);
        b{i} = bSa*Sa_ratios(blg);
        clear Sa50 bSa
    end
    for i=1:MC
        LR(blg).lr(i,:) = damage_to_loss(Sa, b, i, iml);
        hold on
        plot(iml,LR(blg).lr(i,:))
    end
    LR50s(blg,:) = mean(LR(blg).lr); % Define Vulnerability curve for each building
    bLRs(blg,:) = std(LR(blg).lr);
end

for blg=1:noBlg
    LR50s(blg,:) = LR50s(blg,:)*w(blg);
end
LR50 = sum(LR50s);
for blg = 1:noBlg
    bLRs2(blg,:) = ((LR50s(blg,:)-LR50).^2+bLRs(blg,:).^2)*w(blg);
end

bLR = sum(bLRs2).^0.5;
